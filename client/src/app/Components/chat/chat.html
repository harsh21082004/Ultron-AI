<!-- This outer check resolves the 'messages' object once, fixing strict template errors -->
@if (messages$ | async; as messages) {
<!-- Main container now supports light and dark themes -->
<div class="flex flex-col h-full w-full text-gray-800 dark:text-white">

  <app-header></app-header>

  <!-- This container holds the scrolling chat messages -->
  <div #chatContainer class="flex-grow w-full chat-container overflow-y-auto">

    <!-- This inner div is for centering the content -->
    <div class="w-full max-w-4xl mx-auto p-6 space-y-6">
      <!-- Welcome screen or chat messages -->
      @if (messages.length === 0) {
      <div class="flex flex-col items-center justify-center h-full text-center">
        <div
          class="w-24 h-24 rounded-full bg-gradient-to-br from-purple-600 via-pink-500 to-blue-400 mb-6 shadow-2xl animate-pulse">
        </div>
        @if (user$ | async; as user) {
        <h1 class="text-4xl font-bold text-black dark:text-white">Good Evening, {{ user.name }}.</h1>
        } @else {
        <h1 class="text-4xl font-bold text-black dark:text-gray-100">Good Evening.</h1>
        }
        <h2 class="text-3xl font-semibold mt-2">Can I help you with anything?</h2>
      </div>
      } @else {
      <!-- Chat messages -->
      @for (message of messages; track $index){
      <div #messageElement class="flex items-start gap-3" [class.justify-end]="message.sender === 'user'"
        [class.flex-col]="message.sender === 'ai'">
        @if (message.sender === 'ai') {
        <div class="relative w-full h-11 flex-shrink-0 flex items-center">
          <!-- The spinner is shown only for the message that is actively streaming -->
          @if (message.isStreaming) {
          <div class="absolute w-auto h-full">
            <ultron-loader class="h-full w-auto flex"></ultron-loader>
          </div>
          <span class="ml-14 ">Thinking...</span>
          }
          <!-- The AI icon is always visible in the center -->
          <div
            class="absolute inset-0 w-6 h-6 rounded-full flex items-center justify-center font-bold text-sm ai-response">
            <img src="assets/images/logo.svg" alt="">
          </div>
        </div>
        }
        <div class="max-w-2xl py-2 px-4 " [ngClass]="{
                  'user-bubble': message.sender === 'user',
                  'rounded-t-2xl rounded-br-2xl rounded-bl-md': message.sender === 'ai'
                }" [ngStyle]="message.sender === 'ai' ? {'background-color': 'transparent !important'} : null">
          @for (block of message.content; track $index) {
          <app-content-renderer [content]="block.value" [sender]="message.sender"
            class="text-base"></app-content-renderer>
          }
        </div>
      </div>
      }
      }
    </div>
  </div>

  <!-- Chat Input Area -->
  <div class="w-full max-w-4xl mx-auto p-4 pt-0">
    @if ((messages.length === 0) && !(isLoading$ | async)) {
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-left mt-4">
      @for (prompt of promptSuggestions; track prompt.title) {
      <button (click)="sendSuggestion(prompt.title)"
        class="bg-gray-100 dark:bg-[#162731] p-4 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors border border-gray-300 dark:border-gray-700 text-left">
        <h3 class="font-semibold text-sm">{{ prompt.title }}</h3>
        <p class="text-xs mt-1">{{ prompt.description }}</p>
      </button>
      }
    </div>
    }

    <form [formGroup]="chatForm" (ngSubmit)="sendMessage()" class="chat-input-content rounded-2xl p-2 mt-4">
      <textarea formControlName="message" rows="1" placeholder="Message AI Chat..."
        class="w-full bg-transparent resize-none py-2 px-4 placeholder-gray-500 focus:outline-none"
        (keydown)="handleEnterPress($event)" (input)="autoGrow($event)"></textarea>
      <div class="flex items-center justify-between mt-2">
        <div class="flex items-center gap-2">
          <button type="button" mat-stroked-button class="border-gray-300 dark:border-gray-600">
            <mat-icon>mic</mat-icon>
          </button>
          <button type="button" mat-stroked-button class="border-gray-300 dark:border-gray-600">
            <mat-icon>add_photo_alternate</mat-icon> Create an Image
          </button>
          <button type="button" mat-stroked-button class="border-gray-300 dark:border-gray-600">
            <mat-icon>search</mat-icon> Search the web
          </button>
        </div>
        <button type="submit" mat-fab
          class="bg-gray-200 dark:bg-gray-700 hover:bg-pink-600 disabled:bg-gray-300 dark:disabled:bg-gray-800"
          [disabled]="chatForm.invalid || (isLoading$ | async)" aria-label="Send message">
          <mat-icon>arrow_forward</mat-icon>
        </button>
      </div>
    </form>
  </div>
</div>
}