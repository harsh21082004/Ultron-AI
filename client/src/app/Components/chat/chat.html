<!-- This outer check resolves the 'messages' object once, fixing strict template errors -->
@if (messages$ | async; as messages) {
<!-- Main container with the M3-style dark background -->
<div class="flex flex-col h-full w-full text-white py-1.75">

  <app-header></app-header>

  <!-- This container holds the scrolling chat messages -->
  <div #chatContainer class="flex-grow w-full h-full max-w-4xl mx-auto overflow-y-auto p-6 space-y-6 chat-container">

    <!-- This block shows the initial welcome screen if there are no messages -->
    @if (messages.length === 0) {
    <div class="flex flex-col items-center justify-center h-full text-center">

      <!-- M3-style decorative sphere -->
      <div
        class="w-24 h-24 rounded-full bg-gradient-to-br from-purple-600 via-pink-500 to-blue-400 mb-6 shadow-2xl animate-pulse">
      </div>

      <!-- Greeting Text -->
      @if (user$ | async; as user) {
      <h1 class="text-4xl font-bold text-gray-100">Good Evening, {{ user.name }}.</h1>
      } @else {
      <h1 class="text-4xl font-bold text-gray-100">Good Evening.</h1>
      }
      <h2 class="text-3xl font-semibold text-gray-400 mt-2">Can I help you with anything?</h2>

    </div>
    } @else {
    <!-- This block shows the actual chat messages once the conversation starts -->
    @for (message of messages; track $index) {
    <div class="flex items-start gap-3" [class.justify-end]="message.sender === 'user'">
      @if (message.sender === 'ai') {
      <div
        class="w-9 h-9 rounded-full bg-gradient-to-br from-purple-600 to-pink-500 flex items-center justify-center font-bold text-sm flex-shrink-0">
        A</div>
      }
      <div class="max-w-2xl p-4" [ngClass]="{
                'bg-[#2A2B32] text-gray-200 rounded-t-2xl rounded-bl-2xl rounded-br-md': message.sender === 'user',
                'bg-[#1C1D21] text-gray-300 rounded-t-2xl rounded-br-2xl rounded-bl-md': message.sender === 'ai'
              }">
        <div class="whitespace-pre-wrap">{{ message.content }}</div>
      </div>
    </div>
    }
    <!-- Loading indicator -->
    @if (isLoading$ | async) {
    <div class="flex items-start gap-3">
      <div
        class="w-9 h-9 rounded-full bg-gradient-to-br from-purple-600 to-pink-500 flex items-center justify-center font-bold text-sm flex-shrink-0">
        A</div>
      <div class="max-w-xl p-4 rounded-lg bg-[#1C1D21]">
        <div class="flex items-center gap-2">
          <span class="w-2 h-2 bg-gray-500 rounded-full animate-pulse [animation-delay:0s]"></span>
          <span class="w-2 h-2 bg-gray-500 rounded-full animate-pulse [animation-delay:0.2s]"></span>
          <span class="w-2 h-2 bg-gray-500 rounded-full animate-pulse [animation-delay:0.4s]"></span>
        </div>
      </div>
    </div>
    }
    }
  </div>

  <!-- Chat Input Area (always visible at the bottom) -->
  <div class="w-full max-w-4xl mx-auto p-4 pt-0">
    <form [formGroup]="chatForm" (ngSubmit)="sendMessage()" class="border border-gray-700 rounded-2xl p-2">
      <textarea formControlName="message" rows="1" placeholder="Message AI Chat..."
        class="w-full bg-transparent resize-none py-2 px-4 text-white placeholder-gray-500 focus:outline-none"></textarea>
      <div class="flex items-center justify-between mt-2">
        <div class="flex items-center gap-2">
          <button matMiniFab aria-label="Example icon button with a menu icon">
            <mat-icon>attach_file</mat-icon>
          </button>
          <button type="button"
            class="flex items-center gap-2 text-sm px-3 py-2 rounded-full text-gray-300 transition-colors">
            üñºÔ∏è Create an Image
          </button>
          <button type="button"
            class="flex items-center gap-2 text-sm px-3 py-2 rounded-full text-gray-300 transition-colors">
            üåê Search the web
          </button>
        </div>
        <button type="submit"
          class="w-10 h-10 flex items-center justify-center rounded-full text-gray-300 hover:text-white disabled:text-gray-500 transition-colors"
          [disabled]="chatForm.invalid || (isLoading$ | async)">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7" />
          </svg>
        </button>
      </div>
    </form>

    <!-- Feature Card Suggestions (only on initial screen) with M3 styling -->
    @if (messages.length === 0) {
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-left mt-4">
          @for (prompt of promptSuggestions; track prompt.title) {
            <button 
              (click)="sendSuggestion(prompt.title)"
              class="bg-[#1C1D21] p-4 rounded-xl transition-colors text-gray-400 border border-gray-700 text-left"
            >
              <h3 class="font-semibold text-gray-200 text-sm">{{ prompt.title }}</h3>
              <p class="text-xs text-gray-500 mt-1">{{ prompt.description }}</p>
            </button>
          }
        </div>
      }
  </div>
</div>
}